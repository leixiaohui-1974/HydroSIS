<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>HydroSIS Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #1f2933;
      }
      header {
        background: #1b5e20;
        color: white;
        padding: 1.5rem 2rem;
      }
      main {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        padding: 2rem;
      }
      section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
      }
      h2 {
        margin-top: 0;
        font-size: 1.2rem;
      }
      textarea,
      input,
      button {
        width: 100%;
        padding: 0.6rem;
        margin-top: 0.6rem;
        border-radius: 8px;
        border: 1px solid #cfd8dc;
        font-size: 0.95rem;
      }
      button {
        background: #1b5e20;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #144618;
      }
      pre {
        background: #0f172a;
        color: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        overflow: auto;
        max-height: 260px;
      }
      .messages {
        max-height: 280px;
        overflow-y: auto;
        margin-top: 1rem;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
        padding: 0.8rem;
        background: #f8fafc;
      }
      .message {
        margin-bottom: 0.8rem;
      }
      .message strong {
        display: block;
        margin-bottom: 0.2rem;
      }
      .actions {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 1rem;
      }
      .actions input,
      .actions button {
        width: 100%;
      }
      .progress-container {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .progress-bar-wrapper {
        width: 100%;
        background: #e1e5ee;
        border-radius: 999px;
        overflow: hidden;
        height: 16px;
      }
      .progress-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #1b5e20, #4caf50);
        color: white;
        font-size: 0.75rem;
        text-align: center;
        line-height: 16px;
        transition: width 0.3s ease;
      }
      .progress-status {
        font-size: 0.9rem;
        color: #0f172a;
      }
      .progress-log {
        background: #f1f5f9;
        border-radius: 8px;
        padding: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
      }
      #map {
        width: 100%;
        height: 360px;
        margin-top: 1rem;
        border-radius: 12px;
        border: 1px solid #cbd5e1;
      }
      .section-note {
        font-size: 0.85rem;
        color: #475569;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>HydroSIS 自然语言建模门户</h1>
      <p>通过对话配置情景、触发模拟并查看报告。</p>
    </header>
    <main>
      <section>
        <h2>对话入口</h2>
        <form id="chat-form">
          <label for="chat-input">请输入自然语言指令：</label>
          <textarea id="chat-input" rows="4" placeholder="例如：运行降雨增加 20% 的情景"></textarea>
          <button type="submit">发送</button>
        </form>
        <div class="messages" id="messages"></div>
      </section>
      <section>
        <h2>项目配置</h2>
        <form id="config-form">
          <label for="project-id">项目 ID</label>
          <input id="project-id" value="demo" />
          <label for="actor-id">操作用户 ID（可选，用于受控操作）</label>
          <input id="actor-id" placeholder="当前用户 ID" />
          <label for="config-json">模型配置（JSON）</label>
          <textarea id="config-json" rows="10" placeholder="粘贴 ModelConfig JSON"></textarea>
          <button type="submit">保存配置</button>
        </form>
        <button type="button" id="refresh-projects">刷新项目列表</button>
        <pre id="projects-list">尚无项目信息</pre>
        <pre id="project-overview">项目总览尚未加载</pre>
        <pre id="config-result">等待配置...</pre>
      </section>
      <section>
        <h2>水文输入管理</h2>
        <form id="inputs-form">
          <label for="forcing-data">入流数据（JSON，键为子流域）</label>
          <textarea id="forcing-data" rows="8" placeholder='{"S1": [0,10,20]}'></textarea>
          <label for="observations-json">观测流量（JSON，可选）</label>
          <textarea id="observations-json" rows="6" placeholder='{"S3": [0.5,0.8,0.2]}'></textarea>
          <button type="submit">保存水文输入</button>
        </form>
        <div class="actions">
          <button type="button" id="refresh-inputs">刷新输入信息</button>
        </div>
        <div id="inputs-feedback"></div>
        <pre id="inputs-current">尚未配置输入</pre>
      </section>
      <section>
        <h2>情景管理</h2>
        <form id="scenario-create-form">
          <label for="scenario-id">新情景 ID</label>
          <input id="scenario-id" placeholder="scenario_id" />
          <label for="scenario-description">描述</label>
          <input id="scenario-description" placeholder="例如：降雨增加 20%" />
          <label for="scenario-mods">参数调整（JSON）</label>
          <textarea id="scenario-mods" rows="6" placeholder='{"S1": {"routing_model": "lag_long"}}'></textarea>
          <button type="submit">创建情景</button>
        </form>
        <form id="scenario-update-form">
          <label for="scenario-update-id">更新情景 ID</label>
          <input id="scenario-update-id" placeholder="scenario_id" />
          <label for="scenario-update-description">新的描述（可选）</label>
          <input id="scenario-update-description" placeholder="输入新的描述" />
          <label for="scenario-update-mods">参数调整（JSON，可选）</label>
          <textarea id="scenario-update-mods" rows="4" placeholder='{"S2": {"runoff_model": "vic"}}'></textarea>
          <button type="submit">更新情景</button>
        </form>
        <div class="actions">
          <label for="scenario-delete-id">删除情景 ID</label>
          <input id="scenario-delete-id" placeholder="scenario_id" />
          <button type="button" id="scenario-delete">删除情景</button>
          <button type="button" id="refresh-scenarios">刷新情景列表</button>
        </div>
        <div id="scenario-feedback"></div>
        <pre id="scenario-list">尚无情景</pre>
      </section>
      <section>
        <h2>用户与权限</h2>
        <p class="section-note">配置角色后，敏感操作需要提供具备权限的用户 ID。</p>
        <form id="user-create-form">
          <label for="user-id">用户 ID</label>
          <input id="user-id" placeholder="alice" />
          <label for="user-name">姓名（可选）</label>
          <input id="user-name" placeholder="Alice" />
          <label for="user-roles">全局角色（逗号分隔）</label>
          <input id="user-roles" placeholder="admin,modeler" />
          <label for="user-actor">执行用户 ID（可选）</label>
          <input id="user-actor" placeholder="当前操作人 ID" />
          <button type="submit">创建 / 更新用户</button>
        </form>
        <form id="project-permission-form">
          <label for="permission-user-id">目标用户 ID</label>
          <input id="permission-user-id" placeholder="alice" />
          <label for="permission-role">项目角色（留空则移除）</label>
          <input id="permission-role" placeholder="modeler" />
          <label for="permission-actor">执行用户 ID（可选）</label>
          <input id="permission-actor" placeholder="当前操作人 ID" />
          <button type="submit">设置项目角色</button>
        </form>
        <div class="actions">
          <button type="button" id="refresh-users">刷新用户列表</button>
          <button type="button" id="refresh-permissions">刷新项目权限</button>
        </div>
        <div id="user-feedback"></div>
        <pre id="users-list">尚无用户</pre>
        <pre id="project-permissions">尚无项目权限</pre>
      </section>
      <section>
        <h2>任务队列监控</h2>
        <p class="section-note">需要具备 operator/viewer/admin 角色才能查看完整队列。</p>
        <label for="queue-user-id">查询用户 ID（可选）</label>
        <input id="queue-user-id" placeholder="operator" />
        <button type="button" id="refresh-queue">刷新队列状态</button>
        <pre id="queue-status">尚无任务</pre>
      </section>
      <section>
        <h2>GIS 地图展示</h2>
        <p class="section-note">上传 GeoJSON 图层后，可在地图上查看子流域与工程信息。</p>
        <form id="map-form">
          <label for="map-layers-json">图层配置（JSON，键为图层名，值为 GeoJSON）</label>
          <textarea
            id="map-layers-json"
            rows="8"
            placeholder='{"subbasins": {"type": "FeatureCollection", "features": []}}'
          ></textarea>
          <label for="map-user-id">操作用户 ID（可选）</label>
          <input id="map-user-id" placeholder="gis" />
          <button type="submit">保存图层</button>
        </form>
        <div id="map-feedback"></div>
        <div id="map" aria-label="流域地图"></div>
        <pre id="map-layers-meta">尚未加载地图图层</pre>
      </section>
      <section>
        <h2>触发模拟</h2>
        <form id="run-form">
          <label for="forcing-json">输入流量（JSON，键为子流域，值为数组）</label>
          <textarea id="forcing-json" rows="8" placeholder='{"S1": [1,2,3], "S2": [0,1,0]}'></textarea>
          <label for="scenarios">情景 ID（用逗号分隔，留空则运行全部）</label>
          <input id="scenarios" placeholder="scenario_a,scenario_b" />
          <label>
            <input type="checkbox" id="persist" /> 持久化输出
          </label>
          <label>
            <input type="checkbox" id="report" /> 生成报告
          </label>
        <button type="submit">执行</button>
      </form>
      <button type="button" id="refresh-runs">刷新运行记录</button>
      <pre id="run-result">等待运行...</pre>
      <div class="progress-container">
        <div class="progress-bar-wrapper">
          <div id="run-progress-bar" class="progress-bar-fill">0%</div>
        </div>
        <div id="run-progress-status" class="progress-status">尚未开始实时进度</div>
        <div id="run-progress-log" class="progress-log">尚未开始实时进度</div>
      </div>
      <pre id="run-history">尚无运行记录</pre>
      <div class="actions">
        <label for="summary-run-id">运行 ID（用于查看摘要）</label>
        <input id="summary-run-id" placeholder="自动填入最近一次运行" />
          <button type="button" id="fetch-summary">查看运行摘要</button>
          <button type="button" id="fetch-timeseries">查看时序数据</button>
          <button type="button" id="fetch-evaluation">查看评估结果</button>
        </div>
        <pre id="run-summary">尚未加载摘要</pre>
        <pre id="run-timeseries">尚未加载时序</pre>
        <pre id="run-evaluation">尚未加载评估</pre>
      </section>
    </main>
    <script>
      const messagesEl = document.getElementById("messages");
      const projectInput = document.getElementById("project-id");
      const actorInput = document.getElementById("actor-id");
      const overviewEl = document.getElementById("project-overview");
      const scenarioFeedback = document.getElementById("scenario-feedback");
      const inputsFeedback = document.getElementById("inputs-feedback");
      const progressStatusEl = document.getElementById("run-progress-status");
      const progressBarEl = document.getElementById("run-progress-bar");
      const progressLogEl = document.getElementById("run-progress-log");
      const usersListEl = document.getElementById("users-list");
      const userFeedbackEl = document.getElementById("user-feedback");
      const permissionsEl = document.getElementById("project-permissions");
      const queueStatusEl = document.getElementById("queue-status");
      const mapLayersMetaEl = document.getElementById("map-layers-meta");
      const mapFeedbackEl = document.getElementById("map-feedback");
      let runEventSource = null;
      let mapInstance = null;
      let mapLayerGroup = null;
      const defaultMapView = { lat: 30, lng: 105, zoom: 4 };

      function buildQuery(params) {
        const search = new URLSearchParams();
        Object.entries(params || {}).forEach(([key, value]) => {
          if (value === undefined || value === null || value === "") {
            return;
          }
          search.append(key, value);
        });
        const queryString = search.toString();
        return queryString ? `?${queryString}` : "";
      }

      function ensureMap() {
        if (typeof L === "undefined") {
          mapFeedbackEl.textContent = "Leaflet 库未加载，无法展示地图。";
          return null;
        }
        if (!mapInstance) {
          mapInstance = L.map("map");
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap 贡献者",
          }).addTo(mapInstance);
          mapLayerGroup = L.layerGroup().addTo(mapInstance);
          mapInstance.setView(
            [defaultMapView.lat, defaultMapView.lng],
            defaultMapView.zoom
          );
        }
        if (!mapLayerGroup) {
          mapLayerGroup = L.layerGroup().addTo(mapInstance);
        }
        return mapInstance;
      }

      function renderMapLayers(layers) {
        const map = ensureMap();
        if (!map || !mapLayerGroup) {
          return;
        }
        mapLayerGroup.clearLayers();
        let bounds = null;
        let hasData = false;
        Object.entries(layers || {}).forEach(([name, geojson]) => {
          if (!geojson || typeof geojson !== "object") {
            return;
          }
          try {
            const layer = L.geoJSON(geojson, {
              style: () => ({
                color: name.includes("stream") ? "#2563eb" : "#0f766e",
                weight: name.includes("stream") ? 2 : 1.5,
                fillOpacity: 0.25,
              }),
              pointToLayer: (feature, latlng) =>
                L.circleMarker(latlng, {
                  radius: 6,
                  color: "#f97316",
                  fillColor: "#fb923c",
                  fillOpacity: 0.9,
                  weight: 1,
                }),
            });
            layer.bindTooltip(name);
            mapLayerGroup.addLayer(layer);
            if (typeof layer.getBounds === "function") {
              const layerBounds = layer.getBounds();
              if (layerBounds && layerBounds.isValid()) {
                bounds = bounds ? bounds.extend(layerBounds) : layerBounds;
                hasData = true;
              }
            }
          } catch (err) {
            console.warn("渲染图层失败", name, err);
          }
        });
        if (hasData && bounds) {
          map.fitBounds(bounds, { padding: [20, 20] });
        } else {
          map.setView(
            [defaultMapView.lat, defaultMapView.lng],
            defaultMapView.zoom
          );
        }
      }

      function currentActorId() {
        return actorInput ? actorInput.value.trim() : "";
      }

      function resetProgressDisplay() {
        progressBarEl.style.width = "0%";
        progressBarEl.textContent = "0%";
        progressStatusEl.textContent = "尚未开始实时进度";
        progressLogEl.textContent = "尚未开始实时进度";
      }

      function appendProgressLog(entry) {
        const timestamp = entry.timestamp || new Date().toISOString();
        const message = entry.message || `${entry.stage || "阶段"} ${entry.status || "更新"}`;
        const line = `[${timestamp}] ${message}`;
        if (!progressLogEl.textContent || progressLogEl.textContent === "尚未开始实时进度") {
          progressLogEl.textContent = line;
          return;
        }
        progressLogEl.textContent = `${line}\n${progressLogEl.textContent}`;
      }

      function updateProgressDisplay(event) {
        if (typeof event.percent === "number") {
          progressBarEl.style.width = `${event.percent}%`;
          progressBarEl.textContent = `${event.percent}%`;
        }
        if (event.message) {
          progressStatusEl.textContent = event.message;
        }
        appendProgressLog(event);
      }

      function closeRunStream() {
        if (runEventSource) {
          runEventSource.close();
          runEventSource = null;
        }
      }

      function openRunStream(runId) {
        if (typeof EventSource === "undefined") {
          progressStatusEl.textContent = "浏览器不支持实时事件流";
          return;
        }
        closeRunStream();
        progressBarEl.style.width = "0%";
        progressBarEl.textContent = "0%";
        progressLogEl.textContent = "";
        progressStatusEl.textContent = "运行已排队，等待开始";
        runEventSource = new EventSource(`/runs/${runId}/stream`);
        runEventSource.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data || "{}");
            updateProgressDisplay(payload);
            loadQueue();
            if (payload.status === "completed") {
              closeRunStream();
              loadRuns();
              loadOverview();
              loadRunSummary(runId);
              loadRunTimeseries(runId);
              loadRunEvaluation(runId);
            } else if (payload.status === "failed") {
              closeRunStream();
            }
          } catch (err) {
            appendProgressLog({ message: `解析进度事件失败: ${err}` });
          }
        };
        runEventSource.onerror = () => {
          appendProgressLog({ message: "进度流连接已断开" });
          closeRunStream();
        };
      }

      function currentProjectId() {
        return projectInput.value || "demo";
      }

      async function loadProjects() {
        try {
          const response = await fetch(`/projects`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("projects-list").textContent = JSON.stringify(data.projects || [], null, 2);
          await loadInputs();
          await loadOverview();
          await loadProjectPermissions();
          await loadMapLayers();
          await loadRuns();
        } catch (err) {
          document.getElementById("projects-list").textContent = `项目列表加载失败: ${err}`;
        }
      }

      async function loadOverview() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/overview`);
          if (response.status === 404) {
            overviewEl.textContent = "尚未配置项目或缺少总览数据";
            return;
          }
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          overviewEl.textContent = JSON.stringify(data, null, 2);
          if (data.latest_run && data.latest_run.id) {
            const summaryInput = document.getElementById("summary-run-id");
            if (!summaryInput.value) {
              summaryInput.value = data.latest_run.id;
            }
          }
        } catch (err) {
          overviewEl.textContent = `项目总览加载失败: ${err}`;
        }
      }

      async function loadInputs() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/inputs`);
          if (response.status === 404) {
            document.getElementById("inputs-current").textContent = "尚未配置输入";
            return;
          }
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("inputs-current").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          document.getElementById("inputs-current").textContent = `输入加载失败: ${err}`;
        }
      }

      async function loadScenarios() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/scenarios`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("scenario-list").textContent = JSON.stringify(data.scenarios || [], null, 2);
        } catch (err) {
          document.getElementById("scenario-list").textContent = `情景加载失败: ${err}`;
        }
      }

      async function loadRuns() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/runs`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("run-history").textContent = JSON.stringify(data.runs || [], null, 2);
          if (data.runs && data.runs.length && !document.getElementById("summary-run-id").value) {
            document.getElementById("summary-run-id").value = data.runs[0].id;
          }
        } catch (err) {
          document.getElementById("run-history").textContent = `运行记录加载失败: ${err}`;
        }
      }

      async function loadUsers() {
        try {
          const response = await fetch(`/users`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          usersListEl.textContent = JSON.stringify(data.users || [], null, 2);
        } catch (err) {
          usersListEl.textContent = `用户列表加载失败: ${err}`;
        }
      }

      async function loadProjectPermissions() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/permissions`);
          if (response.status === 404) {
            permissionsEl.textContent = "项目不存在或尚未配置权限";
            return;
          }
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          permissionsEl.textContent = JSON.stringify(data.permissions || {}, null, 2);
        } catch (err) {
          permissionsEl.textContent = `权限加载失败: ${err}`;
        }
      }

      async function loadQueue() {
        const queueUser = document.getElementById("queue-user-id").value.trim();
        try {
          const response = await fetch(`/runs/queue${buildQuery({ user_id: queueUser || undefined })}`);
          if (response.status === 403) {
            queueStatusEl.textContent = `无权限查看队列: ${await response.text()}`;
            return;
          }
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          queueStatusEl.textContent = JSON.stringify(data.entries || [], null, 2);
        } catch (err) {
          queueStatusEl.textContent = `队列状态加载失败: ${err}`;
        }
      }

      async function loadMapLayers() {
        const projectId = currentProjectId();
        try {
          const response = await fetch(`/projects/${projectId}/map`);
          if (response.status === 404) {
            mapLayersMetaEl.textContent = "尚未配置地图图层";
            renderMapLayers({});
            return;
          }
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          mapLayersMetaEl.textContent = JSON.stringify(
            {
              updated_at: data.updated_at,
              layers: Object.keys(data.layers || {}),
            },
            null,
            2
          );
          renderMapLayers(data.layers || {});
          mapFeedbackEl.textContent = "";
        } catch (err) {
          mapLayersMetaEl.textContent = `地图图层加载失败: ${err}`;
        }
      }

      document.getElementById("chat-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const content = document.getElementById("chat-input").value;
        if (!content.trim()) return;
        const response = await fetch(`/conversations/default/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ role: "user", content }),
        });
        const data = await response.json();
        messagesEl.innerHTML = data.messages
          .map(
            (msg) => `
              <div class="message">
                <strong>${msg.role}</strong>
                <div>${msg.content}</div>
                ${msg.intent ? `<small>Intent: ${JSON.stringify(msg.intent)}</small>` : ""}
              </div>
            `
          )
          .join("\n");
        document.getElementById("chat-input").value = "";
      });

      document.getElementById("config-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const configText = document.getElementById("config-json").value;
        try {
          const model = JSON.parse(configText);
          const actorId = currentActorId();
          const response = await fetch(`/projects/${projectId}/config${buildQuery({ user_id: actorId || undefined })}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model }),
          });
          const data = await response.json();
          document.getElementById("config-result").textContent = JSON.stringify(data, null, 2);
          await loadProjects();
          await loadScenarios();
        } catch (err) {
          document.getElementById("config-result").textContent = `配置解析失败: ${err}`;
        }
      });

      document.getElementById("refresh-projects").addEventListener("click", (event) => {
        event.preventDefault();
        loadProjects();
      });

      document.getElementById("inputs-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const forcingText = document.getElementById("forcing-data").value.trim();
        if (!forcingText) {
          inputsFeedback.textContent = "请输入有效的入流数据 JSON";
          return;
        }
        let forcing;
        try {
          forcing = JSON.parse(forcingText);
        } catch (err) {
          inputsFeedback.textContent = `入流数据解析失败: ${err}`;
          return;
        }
        const observationsText = document.getElementById("observations-json").value.trim();
        let observations;
        if (observationsText) {
          try {
            observations = JSON.parse(observationsText);
          } catch (err) {
            inputsFeedback.textContent = `观测数据解析失败: ${err}`;
            return;
          }
        }
        const payload = { forcing };
        if (observations !== undefined) {
          payload.observations = observations;
        }
        const actorId = currentActorId();
        const response = await fetch(`/projects/${projectId}/inputs${buildQuery({ user_id: actorId || undefined })}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          inputsFeedback.textContent = `保存失败: ${await response.text()}`;
          return;
        }
        inputsFeedback.textContent = "输入已更新";
        loadInputs();
        loadOverview();
      });

      document.getElementById("refresh-inputs").addEventListener("click", (event) => {
        event.preventDefault();
        loadInputs();
      });

      document.getElementById("scenario-create-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        let modifications;
        try {
          modifications = JSON.parse(document.getElementById("scenario-mods").value || "{}");
        } catch (err) {
          scenarioFeedback.textContent = `情景参数解析失败: ${err}`;
          return;
        }
        const payload = {
          id: document.getElementById("scenario-id").value,
          description: document.getElementById("scenario-description").value,
          modifications,
        };
        const actorId = currentActorId();
        const response = await fetch(`/projects/${projectId}/scenarios${buildQuery({ user_id: actorId || undefined })}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          scenarioFeedback.textContent = `创建失败: ${await response.text()}`;
          return;
        }
        scenarioFeedback.textContent = "情景创建成功";
        document.getElementById("scenario-create-form").reset();
        loadScenarios();
        loadOverview();
      });

      document.getElementById("scenario-update-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const scenarioId = document.getElementById("scenario-update-id").value;
        let modifications;
        const modsText = document.getElementById("scenario-update-mods").value;
        if (modsText.trim()) {
          try {
            modifications = JSON.parse(modsText);
          } catch (err) {
            scenarioFeedback.textContent = `更新参数解析失败: ${err}`;
            return;
          }
        }
        const payload = {
          description: document.getElementById("scenario-update-description").value || undefined,
          modifications,
        };
        const actorId = currentActorId();
        const response = await fetch(`/projects/${projectId}/scenarios/${scenarioId}${buildQuery({ user_id: actorId || undefined })}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          scenarioFeedback.textContent = `更新失败: ${await response.text()}`;
          return;
        }
        scenarioFeedback.textContent = "情景更新成功";
        document.getElementById("scenario-update-form").reset();
        loadScenarios();
        loadOverview();
      });

      document.getElementById("scenario-delete").addEventListener("click", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const scenarioId = document.getElementById("scenario-delete-id").value;
        if (!scenarioId) {
          scenarioFeedback.textContent = "请先填写情景 ID";
          return;
        }
        const actorId = currentActorId();
        const response = await fetch(`/projects/${projectId}/scenarios/${scenarioId}${buildQuery({ user_id: actorId || undefined })}`, {
          method: "DELETE",
        });
        if (!response.ok) {
          scenarioFeedback.textContent = `删除失败: ${await response.text()}`;
          return;
        }
        scenarioFeedback.textContent = "情景已删除";
        document.getElementById("scenario-delete-id").value = "";
        loadScenarios();
        loadOverview();
      });

      document.getElementById("refresh-scenarios").addEventListener("click", (event) => {
        event.preventDefault();
        loadScenarios();
      });

      document.getElementById("user-create-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const userId = document.getElementById("user-id").value.trim();
        if (!userId) {
          userFeedbackEl.textContent = "请输入用户 ID";
          return;
        }
        const name = document.getElementById("user-name").value.trim();
        const rolesText = document.getElementById("user-roles").value.trim();
        const roles = rolesText
          ? rolesText
              .split(",")
              .map((item) => item.trim())
              .filter(Boolean)
          : [];
        const actorId = document.getElementById("user-actor").value.trim();
        const payload = { id: userId, roles };
        if (name) {
          payload.name = name;
        }
        try {
          const response = await fetch(`/users${buildQuery({ actor_id: actorId || undefined })}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            userFeedbackEl.textContent = `保存用户失败: ${await response.text()}`;
            return;
          }
          userFeedbackEl.textContent = "用户信息已保存";
          await loadUsers();
        } catch (err) {
          userFeedbackEl.textContent = `保存用户失败: ${err}`;
        }
      });

      document.getElementById("project-permission-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const targetUser = document.getElementById("permission-user-id").value.trim();
        if (!targetUser) {
          userFeedbackEl.textContent = "请输入目标用户 ID";
          return;
        }
        const roleText = document.getElementById("permission-role").value.trim();
        const actorId = document.getElementById("permission-actor").value.trim();
        const payload = { user_id: targetUser };
        if (roleText) {
          payload.role = roleText;
        }
        try {
          const response = await fetch(
            `/projects/${projectId}/permissions${buildQuery({ actor_id: actorId || undefined })}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          if (!response.ok) {
            userFeedbackEl.textContent = `设置项目角色失败: ${await response.text()}`;
            return;
          }
          userFeedbackEl.textContent = "项目角色已更新";
          await loadProjectPermissions();
        } catch (err) {
          userFeedbackEl.textContent = `设置项目角色失败: ${err}`;
        }
      });

      document.getElementById("refresh-users").addEventListener("click", (event) => {
        event.preventDefault();
        loadUsers();
      });

      document.getElementById("refresh-permissions").addEventListener("click", (event) => {
        event.preventDefault();
        loadProjectPermissions();
      });

      document.getElementById("refresh-queue").addEventListener("click", (event) => {
        event.preventDefault();
        loadQueue();
      });

      document.getElementById("map-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const text = document.getElementById("map-layers-json").value.trim();
        if (!text) {
          mapFeedbackEl.textContent = "请输入有效的图层 JSON";
          return;
        }
        let layers;
        try {
          layers = JSON.parse(text);
        } catch (err) {
          mapFeedbackEl.textContent = `图层 JSON 解析失败: ${err}`;
          return;
        }
        const mapUser = document.getElementById("map-user-id").value.trim() || currentActorId();
        try {
          const response = await fetch(`/projects/${projectId}/map${buildQuery({ user_id: mapUser || undefined })}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ layers }),
          });
          if (!response.ok) {
            mapFeedbackEl.textContent = `保存图层失败: ${await response.text()}`;
            return;
          }
          mapFeedbackEl.textContent = "地图图层已保存";
          await loadMapLayers();
          await loadOverview();
        } catch (err) {
          mapFeedbackEl.textContent = `保存图层失败: ${err}`;
        }
      });

      document.getElementById("run-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const projectId = currentProjectId();
        const forcingText = document.getElementById("forcing-json").value.trim();
        let forcing;
        if (forcingText) {
          try {
            forcing = JSON.parse(forcingText);
          } catch (err) {
            document.getElementById("run-result").textContent = `降雨数据解析失败: ${err}`;
            return;
          }
        }
        const scenarioText = document.getElementById("scenarios").value;
        const scenario_ids = scenarioText
          .split(",")
          .map((item) => item.trim())
          .filter(Boolean);
        const body = {
          scenario_ids,
          persist_outputs: document.getElementById("persist").checked,
          generate_report: document.getElementById("report").checked,
        };
        if (forcing !== undefined) {
          body.forcing = forcing;
        }
        const actorId = currentActorId();
        const response = await fetch(`/projects/${projectId}/runs${buildQuery({ user_id: actorId || undefined })}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await response.json();
        document.getElementById("run-result").textContent = JSON.stringify(data, null, 2);
        if (data.id) {
          document.getElementById("summary-run-id").value = data.id;
          openRunStream(data.id);
        }
        loadRuns();
        loadOverview();
        loadQueue();
      });

      document.getElementById("refresh-runs").addEventListener("click", (event) => {
        event.preventDefault();
        loadRuns();
      });

      async function loadRunSummary(runId) {
        if (!runId) return;
        try {
          const response = await fetch(`/runs/${runId}/summary`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("run-summary").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          document.getElementById("run-summary").textContent = `摘要获取失败: ${err}`;
        }
      }

      async function loadRunTimeseries(runId) {
        if (!runId) return;
        try {
          const response = await fetch(`/runs/${runId}/timeseries`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("run-timeseries").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          document.getElementById("run-timeseries").textContent = `时序获取失败: ${err}`;
        }
      }

      async function loadRunEvaluation(runId) {
        if (!runId) return;
        try {
          const response = await fetch(`/runs/${runId}/evaluation`);
          if (!response.ok) throw new Error(`请求失败: ${response.status}`);
          const data = await response.json();
          document.getElementById("run-evaluation").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          document.getElementById("run-evaluation").textContent = `评估获取失败: ${err}`;
        }
      }

      document.getElementById("fetch-summary").addEventListener("click", async (event) => {
        event.preventDefault();
        const runId = document.getElementById("summary-run-id").value;
        await loadRunSummary(runId);
        await loadRunTimeseries(runId);
        await loadRunEvaluation(runId);
      });

      document.getElementById("fetch-timeseries").addEventListener("click", async (event) => {
        event.preventDefault();
        const runId = document.getElementById("summary-run-id").value;
        await loadRunTimeseries(runId);
      });

      document.getElementById("fetch-evaluation").addEventListener("click", async (event) => {
        event.preventDefault();
        const runId = document.getElementById("summary-run-id").value;
        await loadRunEvaluation(runId);
      });

      resetProgressDisplay();
      loadProjects();
      loadScenarios();
      loadUsers();
      loadQueue();
    </script>
  </body>
</html>
